<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>FF Bar ‚Ä¢ Player Final</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  background:#000;
  font-family:Arial,Helvetica,sans-serif;
  color:#fff;
}
.container{
  display:flex;
  height:100vh;
}

/* MENU */
.menu{
  width:230px;
  background:#111;
  padding:10px;
  display:flex;
  flex-direction:column;
  gap:8px;
}
.menu h3{margin:6px 0}
.menu button{
  padding:12px;
  background:#00c2ff;
  border:none;
  font-weight:bold;
  cursor:pointer;
}
.menu input{margin-top:6px}

/* LATERAL IMAGENS */
.lateral{
  width:220px;
  background:#fff;
  padding:10px;
  display:grid;
  grid-template-rows:repeat(5,1fr);
  gap:10px;
}
.lateral img{
  width:100%;
  aspect-ratio:1/1;
  object-fit:cover;
  border-radius:8px;
}

/* PLAYER */
.player{
  flex:1;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
}
audio{display:none}
canvas{
  width:80%;
  height:200px;
  margin-top:20px;
  background:#000;
}
</style>
</head>

<body>

<div class="container">

  <!-- MENU -->
  <div class="menu">
    <h3>üéµ G√™neros</h3>
    <button onclick="setGenero('sertanejo')">Sertanejo</button>
    <button onclick="setGenero('brega')">Brega</button>
    <button onclick="setGenero('piseiro')">Piseiro</button>
    <button onclick="setGenero('forro')">Forr√≥</button>

    <hr>

    <label>üìÇ Pasta de m√∫sicas</label>
    <input type="file" id="musicas" webkitdirectory multiple>

    <label>üñºÔ∏è Imagens (at√© 5)</label>
    <input type="file" id="imgs" accept="image/*" multiple>

    <button onclick="iniciar()">‚ñ∂ TOCAR</button>
  </div>

  <!-- IMAGENS -->
  <div class="lateral" id="galeria"></div>

  <!-- PLAYER -->
  <div class="player">
    <h2 id="titulo">Escolha um g√™nero</h2>
    <audio id="audioA" preload="auto"></audio>
    <audio id="audioB" preload="auto"></audio>
    <canvas id="visualizer"></canvas>
  </div>

</div>

<script>
/* ================== BANCO (IndexedDB) ================== */
let db;
indexedDB.open("FF_BAR_DB",1).onupgradeneeded=e=>{
  db=e.target.result;
  db.createObjectStore("musicas",{keyPath:"id",autoIncrement:true});
  db.createObjectStore("imagens",{keyPath:"id",autoIncrement:true});
};
indexedDB.open("FF_BAR_DB",1).onsuccess=e=>db=e.target.result;

/* ================== ESTADO ================== */
let generoAtual=null;
let lista=[];
let index=0;
let tocandoA=true;

/* ================== IMAGENS ================== */
const galeria=document.getElementById("galeria");
function renderImgs(arr){
  galeria.innerHTML="";
  arr.slice(0,5).forEach(src=>{
    const img=document.createElement("img");
    img.src=src;
    galeria.appendChild(img);
  });
  while(galeria.children.length<5){
    const img=document.createElement("img");
    img.style.background="#eee";
    galeria.appendChild(img);
  }
}
(function carregarImgs(){
  const tx=db?.transaction("imagens","readonly");
  if(!tx) return setTimeout(carregarImgs,300);
  const imgs=[];
  tx.objectStore("imagens").openCursor().onsuccess=e=>{
    const c=e.target.result;
    if(c){imgs.push(c.value.src);c.continue();}
    else renderImgs(imgs);
  };
})();

imgs.onchange=()=>{
  const tx=db.transaction("imagens","readwrite");
  const store=tx.objectStore("imagens");
  store.clear();
  [...imgs.files].slice(0,5).forEach(f=>{
    const r=new FileReader();
    r.onload=e=>store.add({src:e.target.result});
    r.readAsDataURL(f);
  });
  tx.oncomplete=()=>alert("Imagens salvas");
};

/* ================== M√öSICAS ================== */
function setGenero(g){
  generoAtual=g;
  titulo.innerText="üé∂ "+g.toUpperCase();
  carregarGenero();
}

musicas.onchange=()=>{
  if(!generoAtual) return alert("Escolhe o g√™nero primeiro");
  const tx=db.transaction("musicas","readwrite");
  const store=tx.objectStore("musicas");
  [...musicas.files].forEach(f=>{
    const r=new FileReader();
    r.onload=e=>store.add({genero:generoAtual,audio:e.target.result});
    r.readAsDataURL(f);
  });
  tx.oncomplete=()=>alert("M√∫sicas adicionadas");
};

function carregarGenero(){
  lista=[]; index=0;
  const tx=db.transaction("musicas","readonly");
  tx.objectStore("musicas").openCursor().onsuccess=e=>{
    const c=e.target.result;
    if(c){
      if(c.value.genero===generoAtual) lista.push(c.value.audio);
      c.continue();
    }
  };
}

/* ================== PLAYER SEM ATRASO ================== */
const audioA=document.getElementById("audioA");
const audioB=document.getElementById("audioB");

function iniciar(){
  if(!lista.length) return alert("Sem m√∫sicas nesse g√™nero");
  tocar();
}

function tocar(){
  const atual=tocandoA?audioA:audioB;
  const prox=tocandoA?audioB:audioA;
  atual.src=lista[index];
  atual.play();

  const proxIndex=(index+1)%lista.length;
  prox.src=lista[proxIndex];

  atual.onended=()=>{
    index=proxIndex;
    tocandoA=!tocandoA;
    tocar();
  };
  iniciarVisualizer(atual);
}

/* ================== VISUALIZER ================== */
const canvas=document.getElementById("visualizer");
const ctx=canvas.getContext("2d");
let audioCtx,analyser,data;

function iniciarVisualizer(audio){
  if(audioCtx) return;
  audioCtx=new AudioContext();
  analyser=audioCtx.createAnalyser();
  analyser.fftSize=256;
  data=new Uint8Array(analyser.frequencyBinCount);
  const src=audioCtx.createMediaElementSource(audio);
  src.connect(analyser);
  analyser.connect(audioCtx.destination);
  draw();
}
function draw(){
  requestAnimationFrame(draw);
  analyser.getByteFrequencyData(data);
  ctx.fillStyle="#000";
  ctx.fillRect(0,0,canvas.width,canvas.height);
  let x=0;
  const w=canvas.width/data.length;
  data.forEach(v=>{
    ctx.fillStyle=`rgb(${v+80},40,40)`;
    ctx.fillRect(x,canvas.height-v,w,v);
    x+=w;
  });
}
</script>

</body>
</html>
